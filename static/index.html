<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testiculate</title>
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <link rel="stylesheet" href="http://localhost:8080/main.css">
  </head>
  <body>
    <script>
        var servicesState = {
            services: null
        }

        function fetchServices() {
            return fetch('http://localhost:8080/services')
            .then(response => response.json())
            .then(data => {
                servicesState.services = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        var ServiceResult = {
            view: function(vnode) {
                return m("div", {class: "serviceResult"}, 
                    m("p", vnode.attrs.Name));
            }
        }

        var ServiceResults = {
            oninit: function() {
                fetchServices()
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(servicesState.services === null) {
                    return m("div", {class: "serviceResults"}, "Searching")
                } else {
                    var args = ["div", {class: "serviceResults"}];
                    args = args.concat(servicesState.services.map(x => m(ServiceResult, x)));
                    return m.apply(this, args);
                }
            }
        }

        var ServiceView = {
            view: function(vnode) {
                return m("div", {class: "serviceView"},
                    m("p", "Services"),
                    m(ServiceResults));
            }
        }

        var ResultsView = {
            view: function(vnode) {
                return m("div", {class: "resultsView"},
                    m("p", "Cool cooll cool"));
            }
        }

        m.route(document.body, "/" + window.location.pathname, {
            "/": ServiceView,
            "/results": ResultsView
        });
    </script>
</body>
</html>