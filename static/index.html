<html>
    <head>
        <index>Testiculate</index>
        <script src="https://unpkg.com/mithril/mithril.js"></script>

    </head>

    <body>
        <script>
            var servicesState = {
                services: null
            }


            function fetchServices() {
                return fetch('http://localhost:8080/services')
                .then(response => response.json())
                .then(data => {
                    servicesState.services = data;
                    m.redraw();
                }).catch(function (err) {
                    console.warn('Something went wrong.', err);
                });
            }

            var ServiceResult = {
                view: function(vnode) {
                    return m("p", vnode.attrs.Name);
                }
            }

            var ServiceResults = {
                oninit: function() {
                    fetchServices()
                    .then(_ => m.redraw());
                },
                view: function(vnode) {
                    if(servicesState.services === null) {
                        return m("div", {class: "results"}, "Searching")
                    } else {
                        var args = ["div", {class: "results"}];
                        console.log(servicesState.services);
                        args = args.concat(servicesState.services.map(x => m(ServiceResult, x)));
                        return m.apply(this, args);
                    }
                }
            }

            var ServiceView = {
                view: function(vnode) {
                    return m("div",
                        m("p", "Some services"),
                        m(ServiceResults));
                }
            }

            var App = {
                view: function(vnode) {
                    return m("div",
                        m(ServiceView));
                }
            };

            m.route(document.body, "/" + window.location.pathname, {
                "/": App,
            })
        </script>
    </body>
</html>