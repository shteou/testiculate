<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testiculate</title>
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <link rel="stylesheet" href="http://localhost:8080/main.css">
  </head>
  <body>
    <script>
        let servicesState = {
            services: null
        }

        function fetchServices() {
            return fetch('http://localhost:8080/services')
            .then(response => response.json())
            .then(data => {
                servicesState.services = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        const ServiceEntry = {
            view: function(vnode) {
                return m("div", {class: "serviceEntry"}, 
                    m("button", {onclick: () => m.route.set("/results/" + vnode.attrs.ID, {name: vnode.attrs.Name})}, vnode.attrs.Name));
            }
        }

        const ServiceResults = {
            oninit: function() {
                fetchServices()
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(servicesState.services === null) {
                    return m("div", {class: "serviceEntries"}, "Searching")
                } else {
                    const args = ["div", {class: "serviceResults"}]
                        .concat(servicesState.services.map(x => m(ServiceEntry, x)));
                    return m.apply(this, args);
                }
            }
        }

        const ServiceView = {
            view: function(vnode) {
                return m("div", {class: "serviceView"},
                    m("p", "Services"),
                    m(ServiceResults));
            }
        }

        const isPassed = function(testResult) {
            return testResult.Failed === 0 && testResult.Errored === 0;
        }

        const ResultEntry = {
            view: function(vnode) {
                let testResult = null;
                if(isPassed(vnode.attrs)) {
                    testResult = m("div", {class: "result resultPassed"}, "☑");
                } else {
                    testResult = m("div", {class: "result resultFailed"}, "☒");
                }

                return m("div", {class: "resultEntry"},
                    testResult);
            }
        }

        const ResultDayColumn = {
            view: function(vnode) {
                const args = ["div", {class: "resultDayColumn"}, m("div", {class: "resultDayColumnDate"}, vnode.attrs.date)]
                    .concat(vnode.attrs.entries.map(x => m(ResultEntry, x)));
                return m.apply(this, args);
            }
        }

        let resultsState = {
            results: null
        }

        function fetchServiceResults(service) {
            return fetch('http://localhost:8080/tests/' + service)
            .then(response => response.json())
            .then(data => {
                resultsState.results = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        const groupBy = function(xs, key) {
            return xs.reduce(function(rv, x) {
                (rv[x[key]] = rv[x[key]] || []).push(x);
                return rv;
            }, {});
        };

        const totalPassed = function(results) {
            return results.filter(isPassed).length;
        }

        const totalFailed = function(results) {
            return results.filter((x) => !isPassed(x)).length;
        }

        const passRate = function(results) {
            return ~~((results.filter(isPassed).length / results.length)*100);
        }

        const ResultMetrics = {
            view: function(vnode) {
                const results = vnode.attrs.results;
                return m("div", {class: "resultMetrics"},
                    m("p", "Builds: " + results.length),
                    m("p", "Passed: " + totalPassed(results)),
                    m("p", "Failed: " + totalFailed(results)),
                    m("p", "Passrate: " + passRate(results) + "%"));
            }
        }

        const ResultEntries = {
            oninit: function(vnode) {
                fetchServiceResults(vnode.attrs.name)
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(resultsState.results === null) {
                    return m("div", {class: "resultEntries"}, "Searching")
                } else {
                    const date = new Date();

                    resultsState.results.forEach((x) => {
                        const batchedDate = new Date(x.CreatedAt);
                        batchedDate.setMilliseconds(~~(batchedDate.getMilliseconds()/100))
                        x.CreatedAtBatched = `${batchedDate.getHours()}${batchedDate.getSeconds()}${batchedDate.getMilliseconds()}`;
                    });
                    const dayGroups = groupBy(resultsState.results, "CreatedAtBatched");

                    const args = ["div", {class: "resultEntries"}, m(ResultMetrics, {results: resultsState.results})]
                        .concat(Object.keys(dayGroups).map(x => m(ResultDayColumn, {date: x, entries: dayGroups[x]})));
                    return m.apply(this, args);
                }
                return m.apply(this, args)
            }
        }

        const ResultsView = {
            view: function(vnode) {
                return m("div", {class: "resultsView"},
                    m("p", "Service - " + m.route.param("name")),
                    m(ResultEntries, {name: m.route.param("name")}));
            }
        }

        m.route(document.body, "/" + window.location.pathname, {
            "/": ServiceView,
            "/results/:serviceid": ResultsView
        });
    </script>
</body>
</html>