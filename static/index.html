<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testiculate</title>
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <link rel="stylesheet" href="http://localhost:8080/main.css">
  </head>
  <body>
    <script>
        var servicesState = {
            services: null
        }

        function fetchServices() {
            return fetch('http://localhost:8080/services')
            .then(response => response.json())
            .then(data => {
                servicesState.services = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        var ServiceEntry = {
            view: function(vnode) {
                return m("div", {class: "serviceEntry"}, 
                    m("button", {onclick: () => m.route.set("/results/" + vnode.attrs.ID, {name: vnode.attrs.Name})}, vnode.attrs.Name));
            }
        }

        var ServiceResults = {
            oninit: function() {
                fetchServices()
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(servicesState.services === null) {
                    return m("div", {class: "serviceEntries"}, "Searching")
                } else {
                    var args = ["div", {class: "serviceResults"}];
                    args = args.concat(servicesState.services.map(x => m(ServiceEntry, x)));
                    return m.apply(this, args);
                }
            }
        }

        var ServiceView = {
            view: function(vnode) {
                return m("div", {class: "serviceView"},
                    m("p", "Services"),
                    m(ServiceResults));
            }
        }

        var ResultEntry = {
            view: function(vnode) {
                var testResult = null;
                if(vnode.attrs.Failed === 0 && vnode.attrs.Errored === 0) {
                    testResult = m("div", {class: "result resultPassed"}, "☑");
                } else {
                    testResult = m("div", {class: "result resultFailed"}, "☒");
                }

                return m("div", {class: "resultEntry"},
                    testResult);
            }
        }

        var ResultDayColumn = {
            view: function(vnode) {
                var args = ["div", {class: "resultDayColumn"}, m("div", {class: "resultDayColumnDate"}, vnode.attrs.date)];
                    args = args.concat(vnode.attrs.entries.map(x => m(ResultEntry, x)));
                    return m.apply(this, args);
            }
        }

        var resultsState = {
            results: null
        }

        function fetchServiceResults(service) {
            return fetch('http://localhost:8080/tests/' + service)
            .then(response => response.json())
            .then(data => {
                resultsState.results = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        var groupBy = function(xs, key) {
            return xs.reduce(function(rv, x) {
                (rv[x[key]] = rv[x[key]] || []).push(x);
                return rv;
            }, {});
        };

        var ResultEntries = {
            oninit: function(vnode) {
                fetchServiceResults(vnode.attrs.name)
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(resultsState.results === null) {
                    return m("div", {class: "resultEntries"}, "Searching")
                } else {
                    let date = new Date();

                    resultsState.results.forEach((x) => {
                        var batchedDate = new Date(x.CreatedAt);
                        batchedDate.setMilliseconds(~~(batchedDate.getMilliseconds()/100))
                        x.CreatedAtBatched = `${batchedDate.getHours()}${batchedDate.getSeconds()}${batchedDate.getMilliseconds()}`;
                    });
                    var dayGroups = groupBy(resultsState.results, "CreatedAtBatched");
                    console.log(dayGroups);

                    var args = ["div", {class: "resultEntries"}];
                    args = args.concat(Object.keys(dayGroups).map(x => m(ResultDayColumn, {date: x, entries: dayGroups[x]})));
                    return m.apply(this, args);
                }
                return m.apply(this, args)
            }
        }

        var ResultsView = {
            view: function(vnode) {
                return m("div", {class: "resultsView"},
                    m("p", "Service - " + m.route.param("name")),
                    m(ResultEntries, {name: m.route.param("name")}));
            }
        }

        m.route(document.body, "/" + window.location.pathname, {
            "/": ServiceView,
            "/results/:serviceid": ResultsView
        });
    </script>
</body>
</html>