<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testiculate</title>
        <script src="https://unpkg.com/mithril/mithril.js"></script>
        <link rel="stylesheet" href="http://localhost:8080/main.css">
  </head>
  <body>
    <script>
        var servicesState = {
            services: null
        }

        function fetchServices() {
            return fetch('http://localhost:8080/services')
            .then(response => response.json())
            .then(data => {
                servicesState.services = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        var ServiceEntry = {
            view: function(vnode) {
                return m("div", {class: "serviceEntry"}, 
                    m("button", {onclick: () => m.route.set("/results/" + vnode.attrs.ID, {name: vnode.attrs.Name})}, vnode.attrs.Name));
            }
        }

        var ServiceResults = {
            oninit: function() {
                fetchServices()
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(servicesState.services === null) {
                    return m("div", {class: "serviceEntries"}, "Searching")
                } else {
                    var args = ["div", {class: "serviceResults"}];
                    args = args.concat(servicesState.services.map(x => m(ServiceEntry, x)));
                    return m.apply(this, args);
                }
            }
        }

        var ServiceView = {
            view: function(vnode) {
                return m("div", {class: "serviceView"},
                    m("p", "Services"),
                    m(ServiceResults));
            }
        }

        var ResultEntry = {
            view: function(vnode) {
                return m("div", {class: "resultEntry"},
                    m("p", JSON.stringify(vnode.attrs)));
            }
        }

        var resultsState = {
            results: null
        }

        function fetchServiceResults(service) {
            return fetch('http://localhost:8080/tests/' + service)
            .then(response => response.json())
            .then(data => {
                resultsState.results = data;
                m.redraw();
            }).catch(function (err) {
                console.warn('Something went wrong.', err);
            });
        }

        var ResultEntries = {
            oninit: function(vnode) {
                fetchServiceResults(vnode.attrs.name)
                .then(_ => m.redraw());
            },
            view: function(vnode) {
                if(resultsState.results === null) {
                    return m("div", {class: "resultEntries"}, "Searching")
                } else {
                    var args = ["div", {class: "resultEntries"}];
                    args = args.concat(resultsState.results.map(x => m(ResultEntry, x)));
                    return m.apply(this, args);
                }
                return m.apply(this, args)
            }
        }

        var ResultsView = {
            view: function(vnode) {
                return m("div", {class: "resultsView"},
                    m("p", "Service - " + m.route.param("name"),
                    m(ResultEntries, {name: m.route.param("name")})));
            }
        }

        m.route(document.body, "/" + window.location.pathname, {
            "/": ServiceView,
            "/results/:serviceid": ResultsView
        });
    </script>
</body>
</html>